<%- include('header') -%>

<style>

#order_total {
  border:0;
}

  h3 {display:inline;
  text-align: right;}

</style>

<script src="http://www.virtuosoft.eu/code/bootstrap-touchspin/bootstrap-touchspin/v3.0.1/jquery.bootstrap-touchspin.js"></script>

    <div class="container">
        <div class="jumbotron">
            <h1>New order</h1>
        </div>
    </div>


    <div class="container">

        <div class="row">
          <div class="container">

              <label for="suppliers">Supplier:
              <input id="suppliers" list="suppliers_list">
              <select class="form-control" id="suppliers_list">
                <option disabled selected value></option>

              <% suppliers.forEach(function(item) { %>

              <option id="supplier_choice" value='<%= item["supplier_name"]+" ("+item["supplier_contact"] %>)' ><%= item["supplier_name"]+" ("+item["supplier_contact"] %>)</option>

              <% }); %>

            </select>
              </label>
</div>
</div>
<div class="row">
  <div class="container">
<p>

</p>
  <label for="products">Product:

  <input id="products" list="products_list">
  <select class="form-control" id="products_list">
  </select>
  </label>
</div>

</div>
<div class="row">
  <div class="container"><label for="products">Quantity:
</div>
<p>

</p>
 <div class="col-xs-4">
    <input id="quantity" type="text" value="1" name="quantity">
    <script>
        $("input[name='quantity']").TouchSpin({min:1});
    </script><p>
</div>
</p>

</div>
<div class="row">
  <div class="container">

              <input type="button" onclick="add_to_order();" class="btn btn-info btn-large pull-right" value="Add to order">

            </div>

</div>

<form action="add_order" method="post">

        <input type="hidden" name="last_price" id="last_price" value=0 >
<div id="content">


<h1>Order summary</h1>
  <div class="container" id="summary">
  </div>

<div>
  <div class="col">
  <h2 class="text-left">Total price</h2>
</div>
</div>

<div class="col pull-left">

    <h3>£</h3><h3 class="text-right" ><input type="text" name="order_total" id="order_total" value=0 ></h3>

</div>

<!-- <a href='add_order' class="btn btn-primary btn-large"><span class="glyphicon glyphicon-floppy-disk"></span> Save order</a> -->

<div class="col pull-right">

  <button type="submit" id="submitBtn" value = "Submit" class="btn btn-success"><span class="glyphicon glyphicon-floppy-disk"></span> Save order</button>
</div>
</form>


</div>



</div>

<script>

(function ($) {
  $('.spinner .btn:first-of-type').on('click', function() {
    $('.spinner input').val( parseInt($('.spinner input').val(), 10) + 1);
  });
  $('.spinner .btn:last-of-type').on('click', function() {
    $('.spinner input').val( parseInt($('.spinner input').val(), 10) - 1);
  });
})(jQuery);
</script>

        <script>
        document.getElementById("submitBtn").disabled = true;

        document.getElementById("order_total").innerHTML = 0;

        <% suppliers.forEach(function(item) { %>

            <%= item["supplier_name"].split(' ').join('_') %> = new Array([<% item["products"].forEach(function(thing) { %>
            "<%= thing["product_name"] %> : £<%= thing["product_price"] %> " ,
            <% }); %>
            ]);

              <% }); %>

              <% suppliers.forEach(function(item) { %>
              <%= item["supplier_name"].split(' ').join('_')%> = <%= item["supplier_name"].split(' ').join('_')%>[0];
              <% }); %>

        $("#suppliers_list").change(function () {
          populateSelect();
        });

        function clearBoxes(){
          document.getElementById("suppliers").value = "";
          document.getElementById("products").value = "";
        }


        function populateSelect(){
            cat=$('#supplier_choice').val().split(" (")[0].split(' ').join('_');
            $('#products_list').html('');
               eval(cat).forEach(function(t) {
                 console.log(t);
                    $('#products_list').append('<option>'+t+'</option>');
                });
            }

            function removeElement(elementId) {
                // Removes an element from the document

                document.getElementById("order_total").value = parseFloat($('#order_total').text()) - prices_dict[elementId] ;
                if (document.getElementById("order_total").value == 0){
                  document.getElementById("submitBtn").disabled = true;
                }
                else {
                  document.getElementById("submitBtn").disabled = false;
                }
                var element = document.getElementById(elementId);
                element.parentNode.removeChild(element);
                $('#summary hr').remove();


            }

            var fileId = 0; // used by the addFile() function to keep track of IDs
            var prices_dict = {};

            function add_to_order() {
              // console.log($('#suppliers').val().length);
              if ($('#suppliers_list').val().length != 0 && $('#products_list').val().length != 0)   {
              fileId++; // increment fileId to get a unique ID for the new element
              var priceToAdd = parseFloat($('#quantity').val())*(parseFloat($('#products_list').val().split("£")[1]));
              // /var supplier_order = $('#suppliers').val();
                document.getElementById('summary').innerHTML +=

                '<div id='+fileId+'><div class="form-group"><label for="supplier_name">Supplier name:</label><input name="supplier_name" type="text" readonly class="form-control" id="supplier_name" value="'+
                $('#suppliers_list').val().split("(")[0]+
                '"></div><div class="form-group"><label for="supplier_contact">Supplier contact:</label><input type="text" name="supplier_contact" readonly class="form-control" id="supplier_contact" value="'+
               $('#suppliers_list').val().split("(")[1].split(")")[0]+
                 '"></div><div class="form-group"><label for="product_name">Product name:</label><input type="text" name="product_name" readonly class="form-control" id="product_name" value="'+
                $('#products_list').val().split(' :')[0]+
                '"></div><div class="form-group"><label for="price_per_unit">Price per unit (£):</label><input name="product_price"  type="text" readonly class="form-control" id="price_per_unit" value='+
               (parseFloat($('#products_list').val().split("£")[1]))+
                '></div><div class="form-group"><label for="product_quantity">Quantity:</label><input type="text" name="product_quantity" readonly class="form-control" id="product_quantity" value='+
               $('#quantity').val()+
               '></div><div class="form-group"><label for="cost_for_items">Cost for item(s) (£):</label><input name="product_price_total" type="text" readonly class="form-control" id="cost_for_items" value='+
              priceToAdd+
               '></div><a href="" onclick="javascript:removeElement('+fileId + '); return false;">Remove</a></div><hr />';
               var new_total = parseFloat($('#order_total').text()) + priceToAdd;
                document.getElementById("order_total").innerHTML = new_total;
                document.getElementById("order_total").value = new_total;
                document.getElementById("last_price").value = priceToAdd;
                prices_dict[fileId] = parseFloat(priceToAdd);
                if (document.getElementById("order_total").value > 0){
                  document.getElementById("submitBtn").disabled = false;
                }
                clearBoxes();
            }}

        </script>
        <!-- <script>
        $(function () {

          $('#cmd').click(function () {
            window.print()
          // var doc = new jsPDF();
            // $("#cmd").val('');
            // $("#cmd").css('background-color','transparent');
            // $("#cmd").css('border','none');
            //
            // doc.addHTML($('#content')[0], 15, 15, {
            //   'background': '#fff',
            // }, function() {
            //   doc.save('sample-file.pdf');
            //   $("#cmd").val('Print order');
            //   $("#cmd").removeAttr('style');
            //
            // });
          });
        });
        </script> -->
        </body>
